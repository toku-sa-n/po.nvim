name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  luacheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Run LuaCheck
        uses: lunarmodules/luacheck@cc089e3f65acdd1ef8716cc73a3eca24a6b845e4 # v1.2.0

  prettier:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Run Prettier
        run: npx --yes prettier --check .

  stylua:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Run Stylua
        uses: JohnnyMorganz/stylua-action@b6661824b86c9c33121bed87a778b660ba90cf77 # v4.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: 0.20.0
          args: --check .

  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Install Neovim and gettext
        run: sudo apt-get install -y neovim gettext

      - name: Clone Plenary
        run: git clone https://github.com/nvim-lua/plenary.nvim

      - name: Create `init.vim`
        run: |
          echo "lua vim.opt.rtp:append(vim.fn.expand('$GITHUB_WORKSPACE/plenary.nvim')) \
                source $GITHUB_WORKSPACE/plenary.nvim/plugin/plenary.vim" > $GITHUB_WORKSPACE/.config/nvim/init.vim

      - name: Run tests
        run: nvim --headless -c "PlenaryBustedDirectory tests/"
